<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:FactorioModManager.ViewModels"
        xmlns:vmmw="using:FactorioModManager.ViewModels.MainWindow"
        xmlns:converter="using:FactorioModManager.Views.Converters"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="700"
        x:Class="FactorioModManager.Views.MainWindow"
        x:DataType="vmmw:MainWindowViewModel"
        Title="Factorio Mod Manager"
        Width="1500" Height="850"
        MinWidth="1000" MinHeight="700"
        Loaded="Window_Loaded"
        x:Name="RootWindow">

  <Window.Resources>
    <converter:IsNotGameDependencyConverter x:Key="IsNotGameDependencyConverter" />
    <converter:BaseGameVersionConverter x:Key="BaseGameVersionConverter" />
    <converter:IsBaseDependencyConverter x:Key="IsBaseDependencyConverter" />
    <converter:GameDependencyIconPathConverter x:Key="GameDependencyIconPathConverter" />
    <converter:DependencyColorConverter x:Key="DependencyColorConverter" />
    <converter:ExpandCollapseConverter x:Key="ExpandCollapseConverter" />
    <converter:GreaterThanFiveConverter x:Key="GreaterThanFiveConverter" />
  </Window.Resources>

  <Design.DataContext>
    <vmmw:MainWindowViewModel />
  </Design.DataContext>

  <Grid RowDefinitions="Auto,Auto,*,Auto">

    <!-- Menu Bar -->
    <Menu Grid.Row="0">
      <MenuItem Header="_File">
        <MenuItem Header="_Refresh Mods List" Command="{Binding RefreshModsCommand}" />
        <MenuItem Header="_Install Mod" Command="{Binding InstallModCommand}" />
        <MenuItem Header="_Open Mods Folder" Command="{Binding OpenModFolderCommand}" />
        <Separator />
        <MenuItem Header="_View Logs" Click="OpenLogs" />
        <Separator />
        <MenuItem Header="_Settings" Command="{Binding OpenSettingsCommand}" />
      </MenuItem>

      <MenuItem Header="Check for Mod _Updates" Command="{Binding CheckUpdatesCustomCommand}" />
      <MenuItem Header="Check for Mod Manager Updates"
                Command="{Binding CheckForAppUpdatesCommand}" />

      <MenuItem Header="_Help">
        <MenuItem Header="_About" Click="ShowAbout_Click" />
      </MenuItem>
    </Menu>

    <!-- Search/Filter Toolbar -->
    <Border Grid.Row="1" BorderBrush="#333" BorderThickness="0,0,0,1"
            Background="#2B2B2B" Padding="10">
      <Grid ColumnDefinitions="Auto,Auto,*,Auto">
        <!-- Launch Factorio Button (leftmost) -->
        <Button Grid.Column="0"
                Command="{Binding LaunchFactorioCommand}"
                Padding="12,6"
                Margin="0,0,15,0"
                ToolTip.Tip="Launch Factorio"
                Background="#1E5A1E"
                VerticalAlignment="Center">
          <StackPanel Orientation="Horizontal" Spacing="5">
            <TextBlock Text="â–¶" FontSize="14" FontWeight="Bold" />
            <TextBlock Text="Launch Factorio" FontWeight="SemiBold" />
          </StackPanel>
        </Button>
        <TextBlock Grid.Column="1" Text="Search:"
                   VerticalAlignment="Center"
                   Margin="0,0,10,0" />

        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="10">
          <TextBox Watermark="Search mods..."
                   Text="{Binding SearchText}"
                   Width="250"
                   VerticalAlignment="Center" />

          <AutoCompleteBox ItemsSource="{Binding FilteredAuthors}"
                           SelectedItem="{Binding SelectedAuthorFilter}"
                           Text="{Binding AuthorSearchText}"
                           Width="250"
                           Watermark="Filter by author"
                           MinimumPrefixLength="0"
                           FilterMode="Contains"
                           MaxDropDownHeight="300"
                           GotFocus="AuthorBox_OnGotFocus"
                           Name="AuthorFilterBox"
                           VerticalAlignment="Center" />
          <!-- Unused Internal Filter Button -->
          <ToggleButton IsChecked="{Binding ShowOnlyUnusedInternals}"
                        VerticalAlignment="Center"
                        Padding="10,7"
                        ToolTip.Tip="Show only unused internal dependencies">
            <StackPanel Orientation="Horizontal" Spacing="5">
              <TextBlock Text="âš " FontSize="14" />
              <TextBlock Text="Unused Internal" />
            </StackPanel>
          </ToggleButton>

          <!-- Pending Updates Filter Button -->
          <ToggleButton IsChecked="{Binding ShowOnlyPendingUpdates}"
                        VerticalAlignment="Center"
                        Padding="10,7"
                        ToolTip.Tip="Show only mods with pending updates">
            <StackPanel Orientation="Horizontal" Spacing="5">
              <TextBlock Text="â¬‡" FontSize="14" />
              <TextBlock Text="Pending Updates" />
            </StackPanel>
          </ToggleButton>
        </StackPanel>

        <StackPanel Grid.Column="3"
                    VerticalAlignment="Center"
                    Margin="20,0,10,0">
          <TextBlock Text="{Binding ModCountSummary}"
                     FontWeight="Bold" />
          <TextBlock Text="{Binding UnusedInternalWarning}"
                     Foreground="Orange"
                     FontSize="11"
                     IsVisible="{Binding HasUnusedInternals}" />
        </StackPanel>
      </Grid>
    </Border>

    <!-- Main Content -->
    <Grid Grid.Row="2" ColumnDefinitions="200,3*,*">

      <!-- Groups Panel -->
      <Border Grid.Column="0" BorderBrush="#333" BorderThickness="0,0,1,0"
              Background="#252525" Padding="10">
        <Grid RowDefinitions="Auto,*,Auto">
          <TextBlock Grid.Row="0" Text="Mod Groups"
                     FontWeight="Bold" FontSize="14" Margin="0,0,0,10" />

          <ListBox x:Name="GroupsListBox" Grid.Row="1"
                   ItemsSource="{Binding Groups}"
                   SelectedItem="{Binding SelectedGroup}">
            <ListBox.ItemTemplate>
              <DataTemplate>
                <StackPanel Spacing="3">
                  <!-- Display mode -->
                  <StackPanel IsVisible="{Binding !IsRenaming}">
                    <ToolTip.Tip>
                      <StackPanel MaxWidth="300">
                        <TextBlock Text="{Binding Name}" FontWeight="Bold" Margin="0,0,0,5" />
                        <TextBlock Text="Mods in this group:" FontSize="11" Margin="0,0,0,3" />
                        <ItemsControl ItemsSource="{Binding ModNames}">
                          <ItemsControl.ItemTemplate>
                            <DataTemplate>
                              <TextBlock Text="{Binding}" Margin="5,2" FontSize="11" />
                            </DataTemplate>
                          </ItemsControl.ItemTemplate>
                        </ItemsControl>
                      </StackPanel>
                    </ToolTip.Tip>
                    <TextBlock Text="{Binding Name}" FontWeight="Bold" />
                    <TextBlock Text="{Binding StatusText}"
                               FontSize="11" Foreground="#888" />
                    <StackPanel Orientation="Horizontal" Spacing="5" Margin="0,3,0,0">
                      <Button Content="Toggle"
                              Command="{Binding $parent[Window].((vmmw:MainWindowViewModel)DataContext).ToggleGroupCommand}"
                              CommandParameter="{Binding}"
                              FontSize="10" Padding="5,2" />
                      <Button Content="Rename"
                              Command="{Binding $parent[Window].((vmmw:MainWindowViewModel)DataContext).RenameGroupCommand}"
                              CommandParameter="{Binding}"
                              FontSize="10" Padding="5,2" />
                      <Button Content="Delete"
                               Click="DeleteGroup_Click"
                              FontSize="10" Padding="5,2" />
                    </StackPanel>
                  </StackPanel>

                  <!-- Edit mode -->
                  <StackPanel IsVisible="{Binding IsRenaming}" Spacing="5"
                              PropertyChanged="GroupEditPanel_OnPropertyChanged">
                    <TextBox x:Name="GroupNameEditBox" Text="{Binding EditedName}" AttachedToVisualTree="GroupNameEditBox_OnAttachedToVisualTree"
                             Watermark="Group name"
                             KeyDown="GroupNameEditBox_OnKeyDown" />
                    <StackPanel Orientation="Horizontal" Spacing="5">
                      <Button Content="Save"
                              Command="{Binding $parent[Window].((vmmw:MainWindowViewModel)DataContext).ConfirmRenameGroupCommand}"
                              CommandParameter="{Binding}"
                              FontSize="10" Padding="5,2" />
                      <Button Content="Cancel"
                              Click="CancelRename"
                              FontSize="10" Padding="5,2" />
                    </StackPanel>
                  </StackPanel>
                </StackPanel>
              </DataTemplate>
            </ListBox.ItemTemplate>
          </ListBox>

          <StackPanel Grid.Row="2" Spacing="5" Margin="0,10,0,0">
            <Button Content="New Group"
                    Command="{Binding CreateGroupCommand}"
                    HorizontalAlignment="Stretch" />
            <Button Content="Add to Group"
                    Command="{Binding AddMultipleToGroupCommand}"
                    HorizontalAlignment="Stretch" />
            <Button Content="Remove from Group"
                    Command="{Binding RemoveMultipleFromGroupCommand}"
                    HorizontalAlignment="Stretch" />
          </StackPanel>
        </Grid>
      </Border>

      <!-- Mod List -->
      <Border Grid.Column="1" BorderBrush="#333" BorderThickness="0,0,1,0">
        <DataGrid ItemsSource="{Binding FilteredMods}"
                  Name="ModGrid"
                SelectedItem="{Binding SelectedMod}"
                SelectionChanged="DataGrid_OnSelectionChanged"
                AutoGenerateColumns="False"
                CanUserReorderColumns="True"
                CanUserResizeColumns="True"
                GridLinesVisibility="Horizontal"
                IsReadOnly="True"
                SelectionMode="Extended"
                RowHeight="32">
          <DataGrid.Columns>
            <DataGridTemplateColumn Header="Enabled" Width="100" SortMemberPath="IsEnabled">
              <DataGridTemplateColumn.CellTemplate>
                <DataTemplate>
                  <CheckBox
                     HorizontalAlignment="Center"
                     VerticalAlignment="Center"
                     Command="{Binding $parent[Window].((vmmw:MainWindowViewModel)DataContext).ToggleModCommand}"
                     CommandParameter="{Binding}"
                     IsChecked="{Binding IsEnabled}" />
                </DataTemplate>
              </DataGridTemplateColumn.CellTemplate>
            </DataGridTemplateColumn>

            <DataGridTextColumn Header="Name"
                                Binding="{Binding Title}"
                                Width="0.4*" />

            <DataGridTextColumn Header="Version"
                                Binding="{Binding Version}"
                                Width="100" />

            <DataGridTextColumn Header="Author"
                                Binding="{Binding Author}"
                                Width="120" />

            <DataGridTextColumn Header="Category"
                                Binding="{Binding Category}"
                                Width="100" />

            <DataGridTextColumn Header="Group"
                                Binding="{Binding GroupName}"
                                Width="100" />

            <DataGridTextColumn Header="Last Updated"
                                Binding="{Binding LastUpdatedText}"
                                Width="110" />
          </DataGrid.Columns>

          <DataGrid.Styles>
            <Style Selector="DataGridRow" x:DataType="vm:ModViewModel">
              <Setter Property="Background" Value="{Binding RowBrush}" />
            </Style>
          </DataGrid.Styles>
        </DataGrid>
      </Border>

      <!-- Mod Details Panel -->
      <Border Grid.Column="2" Background="#1E1E1E" Padding="15">

        <ScrollViewer x:Name="ModDetailsScroller">
          <Grid>
            <!-- Real details only when a mod is selected -->
            <Grid IsVisible="{Binding ElementName=RootWindow, Path=DataContext.HasSelectedMod}">
              <!-- DataContext = SelectedMod for property bindings -->
              <Grid.DataContext>
                <Binding Path="SelectedMod" />
              </Grid.DataContext>

              <StackPanel Spacing="10">

                <!-- Navigation buttons - Previous wider, Next narrower -->
                <Grid ColumnDefinitions="*,80">
                  <Button Grid.Column="0"
                          Content="â—€ Previous"
                          Command="{Binding ElementName=RootWindow, Path=DataContext.NavigateBackCommand}" />
                  <Button Grid.Column="1"
                          Content="Next â–¶"
                          Command="{Binding ElementName=RootWindow, Path=DataContext.NavigateForwardCommand}"
                          Margin="5,0,0,0" />
                </Grid>

                <Separator />

                <!-- Thumbnail -->
                <Image Source="{Binding Thumbnail}"
                       Width="200" Height="200"
                       Stretch="Uniform" />

                <!-- Mod Details -->
                <TextBlock Text="{Binding Title, TargetNullValue={x:Null}}"
                           FontSize="18" FontWeight="Bold"
                           TextWrapping="Wrap" />

                <TextBlock Text="{Binding Version, TargetNullValue={x:Null}}"
                           Foreground="#888" />

                <!-- Version selector -->
                <StackPanel Spacing="5" IsVisible="{Binding HasMultipleVersions}">
                  <TextBlock Text="Installed Versions:" FontWeight="Bold" />
                  <ComboBox ItemsSource="{Binding AvailableVersions}"
                            SelectedItem="{Binding SelectedVersion}"
                            HorizontalAlignment="Stretch" />

                  <!-- Delete old version button (only shown for non-current versions) -->
                  <Button Content="Delete This Version"
                          Command="{Binding ElementName=RootWindow, Path=DataContext.DeleteOldVersionCommand}"
                          CommandParameter="{Binding}"
                          HorizontalAlignment="Stretch"
                          Background="#8B0000"
                          IsVisible="{Binding IsOldVersionSelected}" />
                </StackPanel>

                <TextBlock Text="{Binding UpdateText}"
                           Foreground="LightGreen"
                           FontWeight="Bold"
                           IsVisible="{Binding HasUpdate}" />

                <!-- Update button -->
                <Button Content="â¬‡ Download and Install Update"
                        Command="{Binding ElementName=RootWindow, Path=DataContext.DownloadUpdateCommand}"
                        CommandParameter="{Binding}"
                        HorizontalAlignment="Stretch"
                        Background="#2D5016"
                        IsVisible="{Binding HasUpdate}" />

                <!-- Download Progress -->
                <StackPanel Spacing="5" IsVisible="{Binding IsDownloading}">
                  <ProgressBar IsIndeterminate="{Binding !HasDownloadProgress}"
                               Value="{Binding DownloadProgress}"
                               Maximum="100"
                               Height="6"
                               Foreground="#4CAF50" />

                  <TextBlock Text="{Binding DownloadStatusText}"
                             FontSize="12"
                             Foreground="#888"
                             TextAlignment="Center" />
                </StackPanel>

                <TextBlock Text="âš  Unused Internal Mod"
                           Foreground="Orange"
                           FontWeight="Bold"
                           IsVisible="{Binding IsUnusedInternal}" />

                <Separator />

                <StackPanel Orientation="Horizontal" Spacing="5">
                  <TextBlock Text="Author:" FontWeight="Bold" VerticalAlignment="Center" />
                  <TextBlock Text="{Binding Author, TargetNullValue='-'}" VerticalAlignment="Center" />
                </StackPanel>

                <StackPanel Orientation="Horizontal" Spacing="5">
                  <TextBlock Text="Category:" FontWeight="Bold" VerticalAlignment="Center" />
                  <TextBlock Text="{Binding Category, TargetNullValue='-'}" VerticalAlignment="Center" />
                </StackPanel>

                <StackPanel Orientation="Horizontal" Spacing="5">
                  <TextBlock Text="Group:" FontWeight="Bold" VerticalAlignment="Center" />
                  <TextBlock Text="{Binding GroupName, TargetNullValue='-'}" VerticalAlignment="Center" />
                </StackPanel>

                <TextBlock Text="Description:" FontWeight="Bold" Margin="0,10,0,0" />
                <TextBlock Text="{Binding Description, TargetNullValue={x:Null}}"
                           TextWrapping="Wrap" />

                <StackPanel>
                  
                  <TextBlock Text="Dependencies"
                               FontWeight="Bold"
                               VerticalAlignment="Center" />

                  <!-- Dependencies header with compact rounded expand button -->
                  <Grid Margin="0,10,10,4">
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="*" />
                      <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <!-- Game dependency icons in a horizontal row -->
                    <ItemsControl ItemsSource="{Binding Dependencies}" Margin="0,10">
                      <!-- Make all items share one horizontal strip -->
                      <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                          <StackPanel Orientation="Horizontal" Spacing="4" />
                        </ItemsPanelTemplate>
                      </ItemsControl.ItemsPanel>

                      <ItemsControl.ItemTemplate>
                        <DataTemplate>
                          <!-- Show only for game dependencies (using invert parameter) -->
                          <StackPanel Orientation="Horizontal"
                                      Spacing="1"
                                      Margin="2,0"
                                      IsVisible="{Binding Converter={StaticResource IsNotGameDependencyConverter}, ConverterParameter=invert}">

                            <!-- Base game version, only for 'base' -->
                            <TextBlock Text="{Binding Converter={StaticResource BaseGameVersionConverter}}"
                                       Foreground="Gray"
                                       FontSize="15"
                                       VerticalAlignment="Center"
                                       Margin="0,0,5,0"
                                       IsVisible="{Binding Converter={StaticResource IsBaseDependencyConverter}}" />

                            <!-- Icon for base / space-age / quality / elevated-rails -->
                            <Image Width="24"
                                   Height="24"
                                   VerticalAlignment="Center"
                                   Source="{Binding Converter={StaticResource GameDependencyIconPathConverter}}" />
                          </StackPanel>
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>
               

                    <!-- Compact rounded expand/collapse control (NO CommandParameter) -->
                    <Border Grid.Column="1"
                            Background="#2F2F2F"
                            BorderBrush="#555"
                            BorderThickness="1"
                            CornerRadius="6"
                            Padding="0"
                            VerticalAlignment="Center"
                            IsVisible="{Binding SortedDependencies.Count, Converter={StaticResource GreaterThanFiveConverter}}">
                      <Button Command="{Binding ToggleDependencyListCommand}"
                              Background="Transparent"
                              BorderThickness="0"
                              Padding="10,6"
                              MinWidth="70"
                              HorizontalAlignment="Center"
                              HorizontalContentAlignment="Center"
                              VerticalAlignment="Center"
                              ToolTip.Tip="Expand / collapse dependency list">
                        <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                          <TextBlock Text="{Binding IsDependencyListExpanded, Converter={StaticResource ExpandCollapseConverter}}"
                                     Foreground="White"
                                     FontSize="12"
                                     VerticalAlignment="Center" />
                        </StackPanel>
                      </Button>
                    </Border>
                  </Grid>

                  

                  <!-- Dependency list: vertical stack of pill buttons -->
                  <ItemsControl ItemsSource="{Binding VisibleDependencies}" Margin="0,6,10,0">
                    <ItemsControl.ItemsPanel>
                      <ItemsPanelTemplate>
                        <StackPanel Orientation="Vertical" Spacing="6" />
                      </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>

                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <!-- Pill-style control. Border and Button kept identical size by Stretch + MinWidth -->
                        <Border CornerRadius="6"
                                Background="{Binding Status, Converter={StaticResource DependencyColorConverter}}"
                                IsVisible="{Binding Name, Converter={StaticResource IsNotGameDependencyConverter}}"
                                Padding="0"
                                MinWidth="200">
                          <Button Content="{Binding Name}"
                                  Background="Transparent"
                                  Foreground="White"
                                  BorderThickness="0"
                                  Padding="10,8"
                                  HorizontalAlignment="Stretch"
                                  MinWidth="200"
                                  Command="{Binding ElementName=RootWindow, Path=DataContext.NavigateToDependencyCommand}"
                                  CommandParameter="{Binding Name}" />
                        </Border>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>

                <StackPanel Orientation="Vertical" Spacing="10" Margin="0,10,15,0">
                  <Button Content="Open Mod File"
                          Click="OpenModFile"
                          HorizontalAlignment="Stretch" />
                  <Button Content="View Mods That Depend On This"
                          Command="{Binding ElementName=RootWindow, Path=DataContext.ViewDependentsCommand}"
                          CommandParameter="{Binding}"
                          HorizontalAlignment="Stretch" />
                  <Button Content="View on Mod Portal"
                          Command="{Binding ElementName=RootWindow, Path=DataContext.OpenModPortalCommand}"
                          HorizontalAlignment="Stretch" />
                  <Button Content="View Source Code"
                          Command="{Binding ElementName=RootWindow, Path=DataContext.OpenSourceUrlCommand}"
                          HorizontalAlignment="Stretch"
                          IsEnabled="{Binding SourceUrl, Converter={x:Static ObjectConverters.IsNotNull}}" />
                  <Button Content="Check for Update"
                          Command="{Binding ElementName=RootWindow, Path=DataContext.CheckSingleModUpdateCommand}"
                          HorizontalAlignment="Stretch" />
                  <Button Content="View Changelog"
                          Command="{Binding ElementName=RootWindow, Path=DataContext.OpenChangelogCommand}"
                          HorizontalAlignment="Stretch" />
                  <Button Content="View Version History"
                          Command="{Binding ElementName=RootWindow, Path=DataContext.OpenVersionHistoryCommand}"
                          HorizontalAlignment="Stretch" />
                  <Separator />
                  <Button Content="Uninstall Mod"
                          Command="{Binding ElementName=RootWindow, Path=DataContext.RemoveModCommand}"
                          CommandParameter="{Binding}"
                          HorizontalAlignment="Stretch" />
                </StackPanel>
              </StackPanel>
            </Grid>

            <!-- Placeholder when nothing selected -->
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center"
                        IsVisible="{Binding !HasSelectedMod}">
              <TextBlock Text="ðŸ” No mod selected"
                         FontSize="18"
                         Foreground="#888"
                         HorizontalAlignment="Center" />
              <TextBlock Text="Select a mod from the list to view details"
                         FontSize="12"
                         Foreground="#666"
                         Margin="0,10,0,0"
                         HorizontalAlignment="Center" />
            </StackPanel>
          </Grid>
        </ScrollViewer>
      </Border>
    </Grid>

    <!-- Status Bar -->
    <Border Grid.Row="3" BorderBrush="#333" BorderThickness="0,1,0,0"
            Background="#2B2B2B" Padding="10">
      <Grid ColumnDefinitions="*,Auto">
        <!-- Status text on the left -->
        <TextBlock Grid.Column="0"
                   Text="{Binding StatusText}"
                   VerticalAlignment="Center" />

        <!-- Factorio version and Space Age icon on the right -->
        <StackPanel Grid.Column="1"
                    Orientation="Horizontal"
                    Spacing="10"
                    VerticalAlignment="Center"
                    IsVisible="{Binding HasFactorioVersion}">

          <!-- Factorio Version -->
          <TextBlock Text="{Binding FactorioVersionText}"
                     Foreground="#888"
                     FontSize="15"
                     VerticalAlignment="Center" />

          <!-- Factorio Icon -->
          <Image Source="/Assets/base.png"
                     Width="20"
                     Height="20"
                     VerticalAlignment="Center"
                     ToolTip.Tip="Space Age DLC Detected"
                     IsVisible="{Binding FactorioVersionText}" />

          <!-- Space Age Icon -->
          <Image Source="/Assets/space-age.png"
                    Width="20"
                    Height="20"
                    VerticalAlignment="Center"
                    ToolTip.Tip="Space Age DLC Detected"
                    IsVisible="{Binding HasSpaceAgeDlc}" />
        </StackPanel>
      </Grid>
    </Border>
  </Grid>
</Window>