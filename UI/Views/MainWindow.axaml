<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:FactorioModManager.ViewModels"
        xmlns:vmmw="using:FactorioModManager.ViewModels.MainWindow"
        xmlns:converter="using:FactorioModManager.Views.Converters"
        xmlns:controls="using:FactorioModManager.Views.Controls"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="700"
        x:Class="FactorioModManager.Views.MainWindow"
        x:DataType="vmmw:MainWindowViewModel"
        Title="Factorio Mod Manager"
        Width="1600" Height="850"
        MinWidth="1000" MinHeight="700"
        Loaded="Window_Loaded"
        x:Name="RootWindow">

  <Window.Resources>
    <converter:IsNotGameDependencyConverter x:Key="IsNotGameDependencyConverter" />
    <converter:HasGameDependenciesConverter x:Key="HasGameDependenciesConverter" />
    <converter:BaseGameVersionConverter x:Key="BaseGameVersionConverter" />
    <converter:IsBaseDependencyConverter x:Key="IsBaseDependencyConverter" />
    <converter:GameDependencyIconPathConverter x:Key="GameDependencyIconPathConverter" />
    <converter:DependencyColorConverter x:Key="DependencyColorConverter" />
    <converter:ExpandCollapseConverter x:Key="ExpandCollapseConverter" />
    <converter:GreaterThanFiveConverter x:Key="GreaterThanFiveConverter" />
    <converter:IsOptionalDependencyConverter x:Key="IsOptionalDependencyConverter" />
    <converter:BoolToOpacityConverter x:Key="BoolToOpacityConverter" />
    <converter:DoubleStringToGridLengthConverter x:Key="DoubleStringToGridLengthConverter" />
    <converter:BoolToBrushConverter x:Key="BoolToBrushConverter" />
    <converter:InverseBooleanConverter x:Key="InverseBooleanConverter" />
    <!-- Toggle command in UI to control visibility -->
  </Window.Resources>

  <Design.DataContext>
    <vmmw:MainWindowViewModel />
  </Design.DataContext>

  <Grid RowDefinitions="Auto,Auto,*,Auto">

    <!-- Menu Bar -->
    <Menu Grid.Row="0">
      <MenuItem Header="_File">
        <MenuItem Header="_Refresh Mods List" Command="{Binding RefreshModsCommand}" />
        <MenuItem Header="_Install Mod" Command="{Binding InstallModCommand}" />
        <MenuItem Header="_Open Mods Folder" Command="{Binding OpenModFolderCommand}" />
        <Separator />
        <MenuItem Header="_View Logs" Click="OpenLogs" />
        <Separator />
        <MenuItem Header="_Settings" Command="{Binding OpenSettingsCommand}" />
      </MenuItem>

      <!-- Combined Updates menu -->
      <MenuItem Header="_Updates">
        <MenuItem Header="Check for Mod _Updates" Command="{Binding CheckUpdatesCustomCommand}" />
        <MenuItem Header="_Update All" Command="{Binding UpdateAllCommand}" />
        <Separator />
        <MenuItem Header="Check for Mod Manager Updates"
                  Command="{Binding CheckForAppUpdatesCommand}" />
      </MenuItem>

      <MenuItem Header="_Help">
        <MenuItem Header="_About" Click="ShowAbout_Click" />
      </MenuItem>
    </Menu>

    <!-- Search/Filter Toolbar -->
    <Border Grid.Row="1" BorderBrush="#333" BorderThickness="0,0,0,1"
            Background="#2B2B2B" Padding="10">
      <Grid ColumnDefinitions="Auto,Auto,*,Auto">
        <!-- Launch Factorio + Groups Toggle (leftmost) -->
        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="10" VerticalAlignment="Center" Margin="0,0,16,0">
          <Button
                Command="{Binding LaunchFactorioCommand}"
                Padding="12,6"
                Margin="0,0,0,0"
                ToolTip.Tip="Launch Factorio"
                Background="#1E5A1E"
                VerticalAlignment="Center">
            <StackPanel Orientation="Horizontal" Spacing="5">
              <TextBlock Text="â–¶" FontSize="14" FontWeight="Bold" />
              <TextBlock Text="Launch Factorio" FontWeight="SemiBold" />
            </StackPanel>
          </Button>

          <!-- Toggle groups panel (persisted). Use ToggleButton bound to AreGroupsVisible so it reflects state -->
          <ToggleButton IsChecked="{Binding AreGroupsVisible, Mode=TwoWay}"
                        Command="{Binding ToggleGroupsCommand}"
                        VerticalAlignment="Center"
                        Padding="10,7"
                        ToolTip.Tip="Show / hide groups panel">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <TextBlock Text="ðŸ“" FontSize="14" />
              <TextBlock Text="Playsets" />
            </StackPanel>
          </ToggleButton>
        </StackPanel>

        <TextBlock Grid.Column="1" Text="Search:"
                   VerticalAlignment="Center"
                   Margin="0,0,10,0" />

        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="10">
          <TextBox Watermark="Search mods..."
                   Text="{Binding SearchText}"
                   Width="250"
                   VerticalAlignment="Center" />

          <AutoCompleteBox ItemsSource="{Binding FilteredAuthors}"
                           SelectedItem="{Binding SelectedAuthorFilter}"
                           Text="{Binding AuthorSearchText}"
                           Width="250"
                           Watermark="Filter by author"
                           MinimumPrefixLength="0"
                           FilterMode="Contains"
                           MaxDropDownHeight="300"
                           GotFocus="AuthorBox_OnGotFocus"
                           Name="AuthorFilterBox"
                           VerticalAlignment="Center" />
          <!-- Unused Internal Filter Button -->
          <ToggleButton IsChecked="{Binding ShowOnlyUnusedInternals}"
                        VerticalAlignment="Center"
                        Padding="10,7"
                        ToolTip.Tip="Show only unused internal dependencies"
                        IsVisible="{Binding HasUnusedInternals}">
            <StackPanel Orientation="Horizontal" Spacing="5">
              <TextBlock Text="âš " FontSize="14" />
              <TextBlock Text="Unused Internal" />
            </StackPanel>
          </ToggleButton>

          <!-- Pending Updates Filter Button -->
          <ToggleButton IsChecked="{Binding ShowOnlyPendingUpdates}"
                        VerticalAlignment="Center"
                        Padding="10,7"
                        ToolTip.Tip="Show only mods with pending updates"
                        IsVisible="{Binding HasUpdates}">
            <StackPanel Orientation="Horizontal" Spacing="5">
              <TextBlock Text="â¬‡" FontSize="14" />
              <TextBlock Text="Pending Updates" />
            </StackPanel>
          </ToggleButton>

          <!-- Update All quick button -->
          <Button Command="{Binding UpdateAllCommand}"
                  VerticalAlignment="Center"
                  Padding="10,7"
                  ToolTip.Tip="Update all mods with pending updates"
                  IsVisible="{Binding HasUpdates}">
            <StackPanel Orientation="Horizontal" Spacing="5">
              <TextBlock Text="â¬†" FontSize="14" />
              <TextBlock Text="Update All" />
            </StackPanel>
          </Button>
        </StackPanel>

        <StackPanel Grid.Column="3"
                    VerticalAlignment="Center"
                    Margin="20,0,10,0">
          <StackPanel Orientation="Horizontal" Spacing="8">
            <TextBlock Text="{Binding EnabledCountText}"
                       FontWeight="Bold" />
            <!-- Divider shown only when there are updates -->
            <TextBlock Text="|"
                       Foreground="#888"
                       VerticalAlignment="Center"
                       IsVisible="{Binding HasUpdates}" />
            <TextBlock Text="{Binding UpdatesCountText}"
                       Foreground="LightGreen"
                       FontWeight="Bold"
                       IsVisible="{Binding HasUpdates}" />
          </StackPanel>

          <TextBlock Text="{Binding UnusedInternalWarning}"
                     Foreground="Orange"
                     FontSize="11"
                     IsVisible="{Binding HasUnusedInternals}" />
        </StackPanel>
      </Grid>
    </Border>

    <!-- Main Content -->
    <Grid Grid.Row="2" x:Name="MainContentGrid">
      <Grid.ColumnDefinitions>
        <!-- Bind first column width to a string property representing pixels; converter will parse it to GridLength -->
        <ColumnDefinition Width="{Binding EffectiveGroupsColumnGridLength, Mode=TwoWay}" />
        <ColumnDefinition Width="{Binding EffectiveSplitterGridLength, Mode=TwoWay}" />
        <!-- GridSplitter column -->
        <ColumnDefinition Width="3*" />
        <ColumnDefinition Width="*" />
      </Grid.ColumnDefinitions>

      <!-- Groups Panel and Mod Lists combined into a single left column grid to avoid overlap -->
      <Grid Grid.Column="0">
        <Grid.RowDefinitions>
          <RowDefinition Height="*" />
          <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Groups Panel -->
        <Border Grid.Row="0" BorderBrush="#333" BorderThickness="0,0,1,0"
                 Background="#252525" Padding="10">
          <Border.Transitions>
            <Transitions>
              <DoubleTransition Property="Opacity" Duration="0:0:0.18" />
            </Transitions>
          </Border.Transitions>
          <Border.Opacity>
            <Binding Path="AreGroupsVisible" Converter="{StaticResource BoolToOpacityConverter}" />
          </Border.Opacity>
          <Border.IsVisible>
            <Binding Path="AreGroupsVisible" />
          </Border.IsVisible>

          <Grid RowDefinitions="Auto,*,Auto">
            <TextBlock Grid.Row="0" Text="Mod Groups"
                       FontWeight="Bold" FontSize="14" Margin="0,0,0,10" />

            <ListBox x:Name="GroupsListBox" Grid.Row="1"
                     ItemsSource="{Binding Groups}"
                     SelectedItem="{Binding SelectedGroup}"
                     DoubleTapped="GroupsListBox_OnDoubleTapped">
              <ListBox.ItemTemplate>
                <DataTemplate>
                  <!-- Highlight entire item when active filter set by binding Border background to IsActiveFilter -->
                  <Border Background="{Binding IsActiveFilter, Converter={StaticResource BoolToBrushConverter}}" CornerRadius="4" Padding="4" Margin="0,0,0,6">
                    <StackPanel Spacing="2">
                      <!-- Display mode -->
                      <StackPanel IsVisible="{Binding !IsRenaming}">
                        <ToolTip.Tip>
                          <StackPanel MaxWidth="300">
                            <TextBlock Text="{Binding Name}" FontWeight="Bold" Margin="0,0,0,4" FontSize="13" />
                            <TextBlock Text="Mods in this group:" FontSize="11" Margin="0,0,0,3" />
                            <ItemsControl ItemsSource="{Binding ModNames}">
                              <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                  <TextBlock Text="{Binding}" Margin="4,1" FontSize="11" />
                                </DataTemplate>
                              </ItemsControl.ItemTemplate>
                            </ItemsControl>
                          </StackPanel>
                        </ToolTip.Tip>
                        <TextBlock Text="{Binding Name}" FontWeight="Bold" FontSize="13" />
                        <TextBlock Text="{Binding StatusText}" FontSize="10" Foreground="#888" Margin="0,2,0,4" />
                        <StackPanel Orientation="Horizontal" Spacing="6">
                          <Button Content="Toggle"
                                  Command="{Binding $parent[Window].((vmmw:MainWindowViewModel)DataContext).ToggleGroupCommand}"
                                  CommandParameter="{Binding}"
                                  FontSize="11" Padding="6,4" />
                          <Button Content="Rename"
                                  Command="{Binding $parent[Window].((vmmw:MainWindowViewModel)DataContext).RenameGroupCommand}"
                                  CommandParameter="{Binding}"
                                  FontSize="11" Padding="6,4" />
                          <Button Content="Delete"
                                 Click="DeleteGroup_Click"
                                 FontSize="11" Padding="6,4" />
                        </StackPanel>
                      </StackPanel>

                      <!-- Edit mode: use shared RenameEditor control -->
                      <controls:RenameEditor IsVisible="{Binding IsRenaming}"
                                             SaveClicked="RenameEditor_SaveClicked"
                                             CancelClicked="RenameEditor_CancelClicked" />
                    </StackPanel>
                  </Border>
                </DataTemplate>
              </ListBox.ItemTemplate>
            </ListBox>

            <StackPanel Grid.Row="2" Spacing="6" Margin="0,10,0,0">
              <Button Content="New Group"
                      Command="{Binding CreateGroupCommand}"
                      HorizontalAlignment="Stretch"
                      Background="#3A3A3A" Foreground="White" Padding="6" />
              <Button Content="Add to Group"
                      Command="{Binding AddMultipleToGroupCommand}"
                      HorizontalAlignment="Stretch"
                      Background="#3A3A3A" Foreground="White" Padding="6" />
              <Button Content="Remove from Group"
                      Command="{Binding RemoveMultipleFromGroupCommand}"
                      HorizontalAlignment="Stretch"
                      Background="#3A3A3A" Foreground="White" Padding="6" />
            </StackPanel>
          </Grid>
        </Border>

        <!-- Mod Lists Panel -->
        <Border Grid.Row="1" BorderBrush="#2A2A2A" BorderThickness="1,10,1,1" Background="#202020" Padding="8" Margin="0,12,0,0">
          <StackPanel>
            <TextBlock Text="Saved Mod Lists" FontWeight="Bold" FontSize="13" Margin="2,0,0,8" />
            <ListBox ItemsSource="{Binding ModLists}" SelectedItem="{Binding SelectedModList}" Name="ModListsListBox" VerticalAlignment="Stretch">
              <ListBox.ItemTemplate>
                <DataTemplate>
                  <Border CornerRadius="4" Padding="6" Background="#2A2A2A" Margin="0,0,0,6">
                    <StackPanel>
                      <controls:RenameEditor IsVisible="{Binding IsRenaming}"
                                             SaveClicked="RenameEditor_SaveClicked"
                                             CancelClicked="RenameEditor_CancelClicked" />

                      <StackPanel IsVisible="{Binding IsRenaming, Converter={StaticResource InverseBooleanConverter}}">
                        <TextBlock Text="{Binding Name}" FontWeight="Bold" />
                        <!-- show number of mods in this list -->
                        <TextBlock Text="{Binding Entries.Count, StringFormat='{}{0} mods'}" FontSize="11" Foreground="#888" />
                        <StackPanel Orientation="Horizontal" Spacing="6" Margin="0,6,0,0">
                          <Button Content="Apply" Command="{Binding DataContext.ApplyModListCommand, ElementName=RootWindow}" CommandParameter="{Binding Name}" FontSize="11" Padding="6" />
                          <Button Content="Rename" Command="{Binding DataContext.StartRenameModListCommand, ElementName=RootWindow}" CommandParameter="{Binding}" FontSize="11" Padding="6" />
                          <Button Content="Delete" Command="{Binding DataContext.DeleteModListCommand, ElementName=RootWindow}" CommandParameter="{Binding Name}" FontSize="11" Padding="6" />
                        </StackPanel>
                      </StackPanel>
                    </StackPanel>
                  </Border>
                </DataTemplate>
              </ListBox.ItemTemplate>
            </ListBox>

            <StackPanel Orientation="Vertical" Spacing="8" Margin="0,6,0,0">
              <Button Content="New List" Command="{Binding CreateModListCommand}" HorizontalAlignment="Stretch" Background="#3A3A3A" Foreground="White" Padding="6" />
            </StackPanel>
          </StackPanel>
        </Border>
      </Grid>

      <!-- GridSplitter to allow resizing Groups column -->
      <GridSplitter Grid.Column="1"
                    Background="#3A3A3A"
                    HorizontalAlignment="Stretch"
                    VerticalAlignment="Stretch"
                    ShowsPreview="True"
                    DragDelta="GridSplitter_DragDelta" />

      <!-- Mod List -->
      <Border Grid.Column="2" BorderBrush="#333" BorderThickness="0,0,1,0">
        <Grid>
          <!-- Data grid shown when not refreshing -->
          <DataGrid ItemsSource="{Binding FilteredMods}"
                     Name="ModGrid"
                     SelectedItem="{Binding SelectedMod}"
                     SelectionChanged="DataGrid_OnSelectionChanged"
                     AutoGenerateColumns="False"
                     CanUserReorderColumns="True"
                     CanUserResizeColumns="True"
                     GridLinesVisibility="Horizontal"
                     IsReadOnly="True"
                     SelectionMode="Extended"
                     RowHeight="32"
                     IsVisible="{Binding !IsRefreshing}">
            <DataGrid.Columns>
              <DataGridTemplateColumn Header="Enabled" Width="100" SortMemberPath="IsEnabled">
                <DataGridTemplateColumn.CellTemplate>
                  <DataTemplate>
                    <CheckBox
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Command="{Binding $parent[Window].((vmmw:MainWindowViewModel)DataContext).ToggleModCommand}"
                       CommandParameter="{Binding}"
                       IsChecked="{Binding IsEnabled}" />
                  </DataTemplate>
                </DataGridTemplateColumn.CellTemplate>
              </DataGridTemplateColumn>

              <DataGridTextColumn Header="Name"
                                  Binding="{Binding Title}"
                                  Width="0.4*" />

              <DataGridTextColumn Header="Version"
                                  Binding="{Binding Version}"
                                  Width="100" />

              <DataGridTextColumn Header="Author"
                                  Binding="{Binding Author}"
                                  Width="120" />

              <DataGridTextColumn Header="Category"
                                  Binding="{Binding Category}"
                                  Width="100"
                                  Tag="CategoryColumn" />

              <DataGridTextColumn Header="Group"
                                  Binding="{Binding GroupName}"
                                  Width="100" />

              <!-- New: Size column, sortable by the numeric SizeOnDiskBytes but displays SizeOnDiskText -->
              <DataGridTextColumn Header="Size"
                                  Binding="{Binding SizeOnDiskText}"
                                  SortMemberPath="SizeOnDiskBytes"
                                  Width="110"
                                  Tag="SizeColumn" />

              <DataGridTemplateColumn Header="Last Updated" Width="120" Tag="LastUpdatedColumn" SortMemberPath="LastUpdated">
                <DataGridTemplateColumn.CellTemplate>
                  <DataTemplate>
                    <TextBlock Text="{Binding LastUpdatedText}" VerticalAlignment="Center" Margin="8,0,8,0" />
                  </DataTemplate>
                </DataGridTemplateColumn.CellTemplate>
              </DataGridTemplateColumn>
            </DataGrid.Columns>

            <DataGrid.Styles>
              <Style Selector="DataGridRow" x:DataType="vm:ModViewModel">
                <Setter Property="Background" Value="{Binding RowBrush}" />
              </Style>
            </DataGrid.Styles>
          </DataGrid>

          <!-- Loading panel shown while refreshing mods -->
          <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="10" IsVisible="{Binding IsRefreshing}">
            <ProgressBar Width="300" Height="6" IsIndeterminate="True" />
            <TextBlock Text="Refreshing mods..." Foreground="#DDD" FontSize="14" HorizontalAlignment="Center" />
          </StackPanel>
        </Grid>
      </Border>

      <!-- Mod Details Panel -->
      <Border Grid.Column="3" Background="#1E1E1E" Padding="15">

        <ScrollViewer x:Name="ModDetailsScroller">
          <Grid>
            <!-- Real details only when a mod is selected -->
            <Grid IsVisible="{Binding ElementName=RootWindow, Path=DataContext.HasSelectedMod}">
              <!-- DataContext = SelectedMod for property bindings -->
              <Grid.DataContext>
                <Binding Path="SelectedMod" />
              </Grid.DataContext>

              <StackPanel Spacing="10">

                <!-- Navigation buttons - Previous wider, Next narrower -->
                <Grid ColumnDefinitions="*,80">
                  <Button Grid.Column="0"
                          Content="â—€ Previous"
                          Command="{Binding ElementName=RootWindow, Path=DataContext.NavigateBackCommand}" />
                  <Button Grid.Column="1"
                          Content="Next â–¶"
                          Command="{Binding ElementName=RootWindow, Path=DataContext.NavigateForwardCommand}"
                          Margin="5,0,0,0" />
                </Grid>

                <Separator />

                <!-- Moved buttons: Mod Portal and Changelog (mirror navigation button sizing) -->
                <Grid ColumnDefinitions="*,105">
                  <Button Grid.Column="0"
                          Content="Mod Portal"
                          Command="{Binding ElementName=RootWindow, Path=DataContext.OpenModPortalCommand}" />

                  <Button Grid.Column="1"
                          Content="Changelog"
                          Command="{Binding ElementName=RootWindow, Path=DataContext.OpenChangelogCommand}"
                          Margin="6,0,0,0" />
                </Grid>

                <!-- Thumbnail -->
                <Image Source="{Binding Thumbnail}"
                       Width="200" Height="200"
                       Stretch="Uniform" />

                <!-- Mod Details -->
                <TextBlock Text="{Binding Title, TargetNullValue={x:Null}}"
                           FontSize="18" FontWeight="Bold"
                           TextWrapping="Wrap" />

                <TextBlock Text="{Binding Version, TargetNullValue={x:Null}}"
                           Foreground="#888" />

                <!-- Version selector -->
                <Grid IsVisible="{Binding HasMultipleVersions}" Margin="0,4,15,0">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*" />
                    <ColumnDefinition Width="1*" />
                  </Grid.ColumnDefinitions>

                  <TextBlock Grid.ColumnSpan="2" Text="Installed Versions:" FontWeight="Bold" />

                  <!-- Left: ComboBox wrapped in a Border for consistent background/rounded corners -->
                  <Border Grid.Column="0"
                          CornerRadius="6"
                          Background="#2B2B2B"
                          Padding="4"
                          Margin="0,26,8,0"
                          VerticalAlignment="Top">
                    <ComboBox ItemsSource="{Binding AvailableVersions}"
                              SelectedItem="{Binding SelectedVersion, Mode=TwoWay}"
                              HorizontalAlignment="Stretch"
                              VerticalAlignment="Center"
                              Background="Transparent"
                              BorderThickness="0"
                              MinHeight="32" />
                  </Border>

                  <!-- Right: Set Active button -->
                  <Button Grid.Column="1"
                          Content="Set Active"
                          Command="{Binding ElementName=RootWindow, Path=DataContext.SetActiveVersionCommand}"
                          CommandParameter="{Binding SelectedVersion}"
                          IsEnabled="{Binding IsOldVersionSelected}"
                          HorizontalAlignment="Stretch"
                          HorizontalContentAlignment="Center"
                          VerticalContentAlignment="Center"
                          VerticalAlignment="Top"
                          Margin="0,26,0,0"
                          MinHeight="40"
                          Padding="8,6"
                          Background="#2D5016"
                          Foreground="White" />
                </Grid>

                <!-- Delete old version button (only shown for non-current versions) -->
                <Button Content="Delete This Version"
                        Command="{Binding ElementName=RootWindow, Path=DataContext.DeleteOldVersionCommand}"
                        CommandParameter="{Binding SelectedVersion}"
                        HorizontalAlignment="Stretch"
                        Background="#8B0000"
                        IsVisible="{Binding IsOldVersionSelected}"
                        Margin="0,4,15,0" />

                <TextBlock Text="{Binding UpdateText}"
                           Foreground="LightGreen"
                           FontWeight="Bold"
                           IsVisible="{Binding HasUpdate}" />

                <!-- Update button -->
                <Button Content="â¬‡ Download and Install Update"
                        Command="{Binding ElementName=RootWindow, Path=DataContext.DownloadUpdateCommand}"
                        CommandParameter="{Binding}"
                        HorizontalAlignment="Stretch"
                        Background="#2D5016"
                        IsVisible="{Binding HasUpdate}" />

                <!-- Download Progress -->
                <StackPanel Spacing="5" IsVisible="{Binding IsDownloading}">
                  <ProgressBar IsIndeterminate="{Binding !HasDownloadProgress}"
                               Value="{Binding DownloadProgress}"
                               Maximum="100"
                               Height="6"
                               Foreground="#4CAF50" />

                  <TextBlock Text="{Binding DownloadStatusText}"
                             FontSize="12"
                             Foreground="#888"
                             TextAlignment="Center" />
                </StackPanel>

                <TextBlock Text="âš  Unused Internal Mod"
                           Foreground="Orange"
                           FontWeight="Bold"
                           IsVisible="{Binding IsUnusedInternal}" />

                <Separator />

                <StackPanel Orientation="Horizontal" Spacing="5">
                  <TextBlock Text="Author:" FontWeight="Bold" VerticalAlignment="Center" />
                  <TextBlock Text="{Binding Author, TargetNullValue='-'}" VerticalAlignment="Center" />
                </StackPanel>

                <StackPanel Orientation="Horizontal" Spacing="5">
                  <TextBlock Text="Category:" FontWeight="Bold" VerticalAlignment="Center" />
                  <TextBlock Text="{Binding Category, TargetNullValue='-'}" VerticalAlignment="Center" />
                </StackPanel>

                <StackPanel Orientation="Horizontal" Spacing="5">
                  <TextBlock Text="Group:" FontWeight="Bold" VerticalAlignment="Center" />
                  <TextBlock Text="{Binding GroupName, TargetNullValue='-'}" VerticalAlignment="Center" />
                </StackPanel>

                <StackPanel Orientation="Horizontal" Spacing="5">
                  <TextBlock Text="Size on disk:" FontWeight="Bold" VerticalAlignment="Center" />
                  <TextBlock Text="{Binding SizeOnDiskText}" VerticalAlignment="Center" />
                </StackPanel>

                <TextBlock Text="Description:" FontWeight="Bold" Margin="0,10,0,0" />
                <TextBlock Text="{Binding Description, TargetNullValue={x:Null}}"
                           TextWrapping="Wrap" />

                <StackPanel IsVisible="{Binding HasDependencies}">

                  <TextBlock Text="Dependencies"
                               FontWeight="Bold"
                               VerticalAlignment="Center" />

                  <!-- Dependencies header with compact rounded expand button -->
                  <!-- Reduced top margin so when game-dependency icons are hidden the gap is smaller -->
                  <Grid Margin="0,4,10,4">
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="*" />
                      <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <!-- Game dependency icons in a horizontal row (only visible when game dependencies found) -->
                    <ItemsControl ItemsSource="{Binding Dependencies}" Margin="0,6"
                                  IsVisible="{Binding Dependencies, Converter={StaticResource HasGameDependenciesConverter}}">
                      <!-- Make all items share one horizontal strip -->
                      <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                          <StackPanel Orientation="Horizontal" Spacing="4" />
                        </ItemsPanelTemplate>
                      </ItemsControl.ItemsPanel>

                      <ItemsControl.ItemTemplate>
                        <DataTemplate>
                          <!-- Show only for game dependencies (using invert parameter) -->
                          <StackPanel Orientation="Horizontal"
                                      Spacing="1"
                                      Margin="2,0"
                                      IsVisible="{Binding Converter={StaticResource IsNotGameDependencyConverter}, ConverterParameter=invert}">

                            <!-- Base game version, only for 'base' -->
                            <TextBlock Text="{Binding Converter={StaticResource BaseGameVersionConverter}}"
                                       Foreground="Gray"
                                       FontSize="15"
                                       VerticalAlignment="Center"
                                       Margin="0,0,5,0"
                                       IsVisible="{Binding Converter={StaticResource IsBaseDependencyConverter}}" />

                            <!-- Icon for base / space-age / quality / elevated-rails -->
                            <Grid Width="24" Height="24" VerticalAlignment="Center">
                              <Image Width="24"
                                     Height="24"
                                     VerticalAlignment="Center"
                                     Source="{Binding Converter={StaticResource GameDependencyIconPathConverter}}"
                                     Stretch="Uniform" />

                              <!-- Yellow translucent mask for optional dependencies -->
                              <Rectangle Fill="#FFFF00"
                                         Opacity="0.35"
                                         IsHitTestVisible="False"
                                         IsVisible="{Binding Converter={StaticResource IsOptionalDependencyConverter}}" />
                            </Grid>
                          </StackPanel>
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Compact rounded expand/collapse control (NO CommandParameter) -->
                    <Border Grid.Column="1"
                            Background="#2F2F2F"
                            BorderBrush="#555"
                            BorderThickness="1"
                            CornerRadius="6"
                            Padding="0"
                            VerticalAlignment="Center"
                            IsVisible="{Binding OnlyModSortedDepedencies.Count, Converter={StaticResource GreaterThanFiveConverter}}">
                      <Button Command="{Binding ToggleDependencyListCommand}"
                              Background="Transparent"
                              BorderThickness="0"
                              Padding="10,6"
                              MinWidth="70"
                              HorizontalAlignment="Center"
                              HorizontalContentAlignment="Center"
                              VerticalAlignment="Center"
                              ToolTip.Tip="Expand / collapse dependency list">
                        <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                          <TextBlock Text="{Binding IsDependencyListExpanded, Converter={StaticResource ExpandCollapseConverter}}"
                                     Foreground="White"
                                     FontSize="12"
                                     VerticalAlignment="Center" />
                        </StackPanel>
                      </Button>
                    </Border>
                  </Grid>

                  <!-- Dependency list: vertical stack of pill buttons -->
                  <ItemsControl ItemsSource="{Binding VisibleDependencies}" Margin="0,6,15,0">
                    <ItemsControl.ItemsPanel>
                      <ItemsPanelTemplate>
                        <StackPanel Orientation="Vertical" Spacing="6" />
                      </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>

                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <!-- Pill-style control. Border and Button kept identical size by Stretch + MinWidth -->
                        <Border CornerRadius="6"
                                Background="{Binding ., Converter={StaticResource DependencyColorConverter}}"
                                IsVisible="{Binding Name, Converter={StaticResource IsNotGameDependencyConverter}}"
                                Padding="0"
                                MinWidth="200">
                          <Button Content="{Binding DisplayText}"
                                  Background="Transparent"
                                  Foreground="White"
                                  BorderThickness="0"
                                  Padding="10,8"
                                  HorizontalAlignment="Stretch"
                                  MinWidth="200"
                                  Command="{Binding ElementName=RootWindow, Path=DataContext.NavigateToDependencyCommand}"
                                  CommandParameter="{Binding DisplayText}" />
                        </Border>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>

                <StackPanel Orientation="Vertical" Spacing="10" Margin="0,10,15,0">
                  <Button Content="View Mod File"
                          Click="OpenModFile"
                          HorizontalAlignment="Stretch" />
                  <Button Content="View Parent Mods"
                          Command="{Binding ElementName=RootWindow, Path=DataContext.ViewDependentsCommand}"
                          CommandParameter="{Binding}"
                          HorizontalAlignment="Stretch" />
                  <Button Content="View Source Code"
                          Command="{Binding ElementName=RootWindow, Path=DataContext.OpenSourceUrlCommand}"
                          HorizontalAlignment="Stretch"
                          IsEnabled="{Binding SourceUrl, Converter={x:Static ObjectConverters.IsNotNull}}" />
                  <Button Content="Refresh Mod Info &amp; Check Update"
                          Command="{Binding ElementName=RootWindow, Path=DataContext.RefreshSelectedModCommand}"
                          HorizontalAlignment="Stretch" />
                  <Button Content="View Version History"
                          Command="{Binding ElementName=RootWindow, Path=DataContext.OpenVersionHistoryCommand}"
                          HorizontalAlignment="Stretch" />
                  <Separator />
                  <Button Content="Uninstall Mod"
                          Command="{Binding ElementName=RootWindow, Path=DataContext.RemoveModCommand}"
                          CommandParameter="{Binding}"
                          HorizontalAlignment="Stretch" />
                </StackPanel>
              </StackPanel>
            </Grid>

            <!-- Placeholder when nothing selected -->
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center"
                        IsVisible="{Binding !HasSelectedMod}">
              <TextBlock Text="ðŸ” No mod selected"
                         FontSize="18"
                         Foreground="#888"
                         HorizontalAlignment="Center" />
              <TextBlock Text="Select a mod from the list to view details"
                         FontSize="12"
                         Foreground="#666"
                         Margin="0,10,0,0"
                         HorizontalAlignment="Center" />
            </StackPanel>
          </Grid>
        </ScrollViewer>
      </Border>
    </Grid>

    <!-- Status Bar -->
    <Border Grid.Row="3" BorderBrush="#333" BorderThickness="0,1,0,0"
            Background="#2B2B2B" Padding="10">
      <Grid ColumnDefinitions="*,Auto">
        <!-- Status text on the left -->
        <TextBlock Grid.Column="0"
                   Text="{Binding StatusText}"
                   VerticalAlignment="Center" />

        <!-- Right area: Factorio version, DLC icon, and Update All progress -->
        <StackPanel Grid.Column="1"
                    Orientation="Horizontal"
                    Spacing="10"
                    VerticalAlignment="Center">

          <!-- Download Progress (shown when running) -->
          <!-- DownloadProgressPanel kept in layout but fades out when IsDownloadProgressVisible is false. Opacity is bound to IsDownloadProgressVisible and animated via Transitions. Hit testing disabled when hidden. -->
          <StackPanel Name="DownloadProgressPanel" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center"
                      Opacity="{Binding IsDownloadProgressVisible, Converter={StaticResource BoolToOpacityConverter}}"
                      IsHitTestVisible="{Binding IsDownloadProgressVisible}">
            <StackPanel.Transitions>
              <Transitions>
                <DoubleTransition Property="Opacity" Duration="0:0:0.32" />
              </Transitions>
            </StackPanel.Transitions>
            <!-- Use a two-column grid: left = progress bar, right = stacked count + speed to avoid overlap -->
            <Grid Height="20">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
              </Grid.ColumnDefinitions>

              <ProgressBar Grid.Column="0" Height="6" IsIndeterminate="False" Minimum="0" Maximum="100"
                           Value="{Binding DownloadProgress.ProgressPercent, Mode=OneWay}"
                           VerticalAlignment="Center"
                           Margin="0,0,8,0" />

              <!-- Right: stacked count and speed -->
              <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Spacing="0">
                <TextBlock Text="{Binding DownloadProgress.ProgressText}" Foreground="#DDD" FontSize="15" HorizontalAlignment="Right"  VerticalAlignment="Center" />
                <TextBlock Text=" | " Foreground="#DDD" FontSize="15" HorizontalAlignment="Right"  VerticalAlignment="Center" />
                <TextBlock Text="{Binding DownloadProgress.SpeedText}" Foreground="#DDD" FontSize="14" HorizontalAlignment="Right" VerticalAlignment="Center" Opacity="0.9" />
              </StackPanel>
            </Grid>
          </StackPanel>

          <!-- Factorio Version -->
          <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center" IsVisible="{Binding HasFactorioVersion}">
            <TextBlock Text="{Binding FactorioVersionText}"
                       Foreground="#888"
                       FontSize="15"
                       VerticalAlignment="Center" />

            <!-- Factorio Icon -->
            <Image Source="/Assets/base.png"
                       Width="20"
                       Height="20"
                       VerticalAlignment="Center"
                       ToolTip.Tip="{Binding FactorioVersionText}" />

            <!-- Space Age Icon -->
            <Image Source="/Assets/space-age.png"
                      Width="20"
                      Height="20"
                      VerticalAlignment="Center"
                      ToolTip.Tip="Space Age DLC Detected!"
                      IsVisible="{Binding HasSpaceAgeDlc}" />
          </StackPanel>
        </StackPanel>
      </Grid>
    </Border>
  </Grid>
</Window>