<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:FactorioModManager.ViewModels"
        xmlns:vmmw="using:FactorioModManager.ViewModels.MainWindow"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="700"
        x:Class="FactorioModManager.Views.MainWindow"
        x:DataType="vmmw:MainWindowVM"
        Title="Factorio Mod Manager"
        Width="1500" Height="850"
        MinWidth="1000" MinHeight="700"
        KeyDown="Window_KeyDown"
        Loaded="Window_Loaded">

  <Design.DataContext>
    <vmmw:MainWindowVM/>
  </Design.DataContext>

  <Grid RowDefinitions="Auto,Auto,*,Auto">

    <!-- Menu Bar -->
    <Menu Grid.Row="0">
      <MenuItem Header="_File">
        <MenuItem Header="_Refresh" Command="{Binding RefreshModsCommand}"/>
        <MenuItem Header="_Install Mod" Command="{Binding InstallModCommand}"/>
        <MenuItem Header="_Open Mod Folder" Command="{Binding OpenModFolderCommand}"/>
        <Separator/>
        <MenuItem Header="Check _Updates" Command="{Binding CheckUpdatesCustomCommand}"/>
        <Separator/>
        <MenuItem Header="_Settings" Command="{Binding OpenSettingsCommand}"/>
        <MenuItem Header="_Logs" Click="OpenLogs"/>
      </MenuItem>

      <MenuItem Header="_View">
        <MenuItem Header="Show _Disabled Mods" IsChecked="{Binding ShowDisabled}"/>
        <MenuItem Header="Filter by Selected _Group" IsChecked="{Binding FilterBySelectedGroup}"/>
      </MenuItem>

      <MenuItem Header="_Help">
        <MenuItem Header="_About" Click="ShowAbout_Click"/>
      </MenuItem>
    </Menu>


    <!-- Search/Filter Toolbar -->
    <Border Grid.Row="1" BorderBrush="#333" BorderThickness="0,0,0,1"
            Background="#2B2B2B" Padding="10">
      <Grid ColumnDefinitions="Auto,*,Auto">
        <TextBlock Grid.Column="0" Text="Search:"
                   VerticalAlignment="Center"
                   Margin="0,0,10,0"/>

        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="10">
          <TextBox Watermark="Search mods..."
                   Text="{Binding SearchText}"
                   Width="250"
                   VerticalAlignment="Center"/>

          <AutoCompleteBox ItemsSource="{Binding FilteredAuthors}"
                           SelectedItem="{Binding SelectedAuthorFilter}"
                           Text="{Binding AuthorSearchText}"
                           Width="250"
                           Watermark="Filter by author"
                           MinimumPrefixLength="0"
                           FilterMode="Contains"
                           MaxDropDownHeight="300"
                           GotFocus="AuthorBox_OnGotFocus"
                           Name="AuthorFilterBox"
                           VerticalAlignment="Center"/>
        </StackPanel>

        <StackPanel Grid.Column="2"
                    VerticalAlignment="Center"
                    Margin="20,0,10,0">
          <TextBlock Text="{Binding ModCountSummary}"
                     FontWeight="Bold"/>
          <TextBlock Text="{Binding UnusedInternalWarning}"
                     Foreground="Orange"
                     FontSize="11"
                     IsVisible="{Binding HasUnusedInternals}"/>
        </StackPanel>
      </Grid>
    </Border>

    <!-- Main Content -->
    <Grid Grid.Row="2" ColumnDefinitions="200,3*,*">

      <!-- Groups Panel -->
      <Border Grid.Column="0" BorderBrush="#333" BorderThickness="0,0,1,0"
              Background="#252525" Padding="10">
        <Grid RowDefinitions="Auto,*,Auto">
          <TextBlock Grid.Row="0" Text="Mod Groups"
                     FontWeight="Bold" FontSize="14" Margin="0,0,0,10"/>

          <ListBox Grid.Row="1"
                   ItemsSource="{Binding Groups}"
                   SelectedItem="{Binding SelectedGroup}">
            <ListBox.ItemTemplate>
              <DataTemplate>
                <StackPanel Spacing="3">
                  <!-- Display mode -->
                  <StackPanel IsVisible="{Binding !IsEditing}">
                    <ToolTip.Tip>
                      <StackPanel MaxWidth="300">
                        <TextBlock Text="{Binding Name}" FontWeight="Bold" Margin="0,0,0,5"/>
                        <TextBlock Text="Mods in this group:" FontSize="11" Margin="0,0,0,3"/>
                        <ItemsControl ItemsSource="{Binding ModNames}">
                          <ItemsControl.ItemTemplate>
                            <DataTemplate>
                              <TextBlock Text="{Binding}" Margin="5,2" FontSize="11"/>
                            </DataTemplate>
                          </ItemsControl.ItemTemplate>
                        </ItemsControl>
                      </StackPanel>
                    </ToolTip.Tip>
                    <TextBlock Text="{Binding Name}" FontWeight="Bold"/>
                    <TextBlock Text="{Binding StatusText}"
                               FontSize="11" Foreground="#888"/>
                    <StackPanel Orientation="Horizontal" Spacing="5" Margin="0,3,0,0">
                      <Button Content="Toggle"
                              Command="{Binding $parent[Window].((vmmw:MainWindowVM)DataContext).ToggleGroupCommand}"
                              CommandParameter="{Binding}"
                              FontSize="10" Padding="5,2"/>
                      <Button Content="Rename"
                              Command="{Binding $parent[Window].((vmmw:MainWindowVM)DataContext).RenameGroupCommand}"
                              CommandParameter="{Binding}"
                              FontSize="10" Padding="5,2"/>
                      <Button Content="Delete"
                              Command="{Binding $parent[Window].((vmmw:MainWindowVM)DataContext).DeleteGroupCommand}"
                              CommandParameter="{Binding}"
                              FontSize="10" Padding="5,2"/>
                    </StackPanel>
                  </StackPanel>

                  <!-- Edit mode -->
                  <StackPanel IsVisible="{Binding IsEditing}" Spacing="5">
                    <TextBox Text="{Binding EditName}" Watermark="Group name"/>
                    <StackPanel Orientation="Horizontal" Spacing="5">
                      <Button Content="Save"
                              Command="{Binding $parent[Window].((vmmw:MainWindowVM)DataContext).ConfirmRenameGroupCommand}"
                              CommandParameter="{Binding}"
                              FontSize="10" Padding="5,2"/>
                      <Button Content="Cancel"
                              Click="CancelRename"
                              FontSize="10" Padding="5,2"/>
                    </StackPanel>
                  </StackPanel>
                </StackPanel>
              </DataTemplate>
            </ListBox.ItemTemplate>
          </ListBox>

          <StackPanel Grid.Row="2" Spacing="5" Margin="0,10,0,0">
            <Button Content="New Group"
                    Command="{Binding CreateGroupCommand}"
                    HorizontalAlignment="Stretch"/>
            <Button Content="Add to Group"
                    Command="{Binding AddMultipleToGroupCommand}"
                    HorizontalAlignment="Stretch"/>
            <Button Content="Remove from Group"
                    Command="{Binding RemoveMultipleFromGroupCommand}"
                    HorizontalAlignment="Stretch"/>
          </StackPanel>
        </Grid>
      </Border>

      <!-- Mod List -->
      <Border Grid.Column="1" BorderBrush="#333" BorderThickness="0,0,1,0">
        <DataGrid ItemsSource="{Binding FilteredMods}"
                SelectedItem="{Binding SelectedMod}"
                SelectionChanged="DataGrid_OnSelectionChanged"
                AutoGenerateColumns="False"
                CanUserReorderColumns="True"
                CanUserResizeColumns="True"
                GridLinesVisibility="Horizontal"
                IsReadOnly="True"
                SelectionMode="Extended"
                RowHeight="32">
          <DataGrid.Columns>
            <DataGridTemplateColumn Header="Enabled" Width="80">
              <DataGridTemplateColumn.CellTemplate>
                <DataTemplate>
                  <CheckBox IsChecked="{Binding IsEnabled}"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"/>
                </DataTemplate>
              </DataGridTemplateColumn.CellTemplate>
            </DataGridTemplateColumn>

            <DataGridTextColumn Header="Name"
                                Binding="{Binding Title}"
                                Width="0.4*"/>

            <DataGridTextColumn Header="Version"
                                Binding="{Binding Version}"
                                Width="100"/>

            <DataGridTextColumn Header="Author"
                                Binding="{Binding Author}"
                                Width="120"/>

            <DataGridTextColumn Header="Category"
                                Binding="{Binding Category}"
                                Width="100"/>

            <DataGridTextColumn Header="Group"
                                Binding="{Binding GroupName}"
                                Width="100"/>

            <DataGridTextColumn Header="Last Updated"
                                Binding="{Binding LastUpdatedText}"
                                Width="110"/>

            <!-- REMOVED: Status column with update icon -->
          </DataGrid.Columns>

          <DataGrid.Styles>
            <Style Selector="DataGridRow" x:DataType="vm:ModViewModel">
              <Setter Property="Background" Value="{Binding RowBrush}"/>
            </Style>
          </DataGrid.Styles>
        </DataGrid>
      </Border>

      <!-- Mod Details Panel -->
      <!-- Mod Details Panel -->
      <Border Grid.Column="2" Background="#1E1E1E" Padding="15">
        <ScrollViewer>
          <StackPanel Spacing="10" IsVisible="{Binding SelectedMod, Converter={x:Static ObjectConverters.IsNotNull}}">
            <!-- Navigation buttons - Previous wider, Next narrower -->
            <Grid ColumnDefinitions="*,80">
              <Button Grid.Column="0" Content="◀ Previous" Command="{Binding NavigateBackCommand}"/>
              <Button Grid.Column="1" Content="Next ▶" Command="{Binding NavigateForwardCommand}" Margin="5,0,0,0"/>
            </Grid>

            <Separator/>

            <!-- Thumbnail -->
            <Image Source="{Binding SelectedMod.Thumbnail}"
                   Width="200" Height="200"
                   Stretch="Uniform"
                   IsVisible="{Binding SelectedMod.Thumbnail, Converter={x:Static ObjectConverters.IsNotNull}}"/>

            <TextBlock Text="{Binding SelectedMod.Title}"
                       FontSize="18" FontWeight="Bold"
                       TextWrapping="Wrap"/>

            <TextBlock Text="{Binding SelectedMod.Version}"
                       Foreground="#888"/>

            <!-- Version selector -->
            <StackPanel Spacing="5" IsVisible="{Binding SelectedMod.HasMultipleVersions}">
              <TextBlock Text="Installed Versions:" FontWeight="Bold"/>
              <ComboBox ItemsSource="{Binding SelectedMod.AvailableVersions}"
                        SelectedItem="{Binding SelectedMod.SelectedVersion}"
                        HorizontalAlignment="Stretch"/>

              <!-- Delete old version button (only shown for non-current versions) -->
              <Button Content="Delete This Version"
                      Command="{Binding DeleteOldVersionCommand}"
                      CommandParameter="{Binding SelectedMod}"
                      HorizontalAlignment="Stretch"
                      Background="#8B0000"
                      IsVisible="{Binding SelectedMod.IsOldVersionSelected}"/>
            </StackPanel>

            <TextBlock Text="{Binding SelectedMod.UpdateText}"
                       Foreground="LightGreen"
                       FontWeight="Bold"
                       IsVisible="{Binding SelectedMod.HasUpdate}"/>

            <!-- Update button -->
            <Button Content="⬇ Download and Install Update"
                    Command="{Binding DownloadUpdateCommand}"
                    CommandParameter="{Binding SelectedMod}"
                    HorizontalAlignment="Stretch"
                    Background="#2D5016"
                    IsVisible="{Binding SelectedMod.HasUpdate}"/>

            <TextBlock Text="⚠ Unused Internal Mod"
                       Foreground="Orange"
                       FontWeight="Bold"
                       IsVisible="{Binding SelectedMod.IsUnusedInternal}"/>

            <Separator/>

            <TextBlock Text="Author:" FontWeight="Bold"/>
            <TextBlock Text="{Binding SelectedMod.Author}"/>

            <TextBlock Text="Category:" FontWeight="Bold"/>
            <TextBlock Text="{Binding SelectedMod.Category}"/>

            <TextBlock Text="Group:" FontWeight="Bold"/>
            <TextBlock Text="{Binding SelectedMod.GroupName}"/>

            <TextBlock Text="Description:" FontWeight="Bold" Margin="0,10,0,0"/>
            <TextBlock Text="{Binding SelectedMod.Description}"
                       TextWrapping="Wrap"/>

            <TextBlock Text="Dependencies:" FontWeight="Bold" Margin="0,10,0,0"/>
            <ItemsControl ItemsSource="{Binding SelectedMod.Dependencies}">
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <Button Content="{Binding}"
                          Command="{Binding $parent[Window].((vmmw:MainWindowVM)DataContext).NavigateToDependencyCommand}"
                          CommandParameter="{Binding}"
                          Margin="5,2,0,2"
                          HorizontalAlignment="Left"/>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>

            <StackPanel Orientation="Vertical" Spacing="10" Margin="0,20,0,0">
              <Button Content="Open Mod File"
                      Click="OpenModFile"
                      HorizontalAlignment="Stretch"/>
              <Button Content="View on Mod Portal"
                      Command="{Binding OpenModPortalCommand}"
                      HorizontalAlignment="Stretch"/>
              <Button Content="View Source Code"
                      Command="{Binding OpenSourceUrlCommand}"
                      HorizontalAlignment="Stretch"
                      IsEnabled="{Binding SelectedMod.SourceUrl, Converter={x:Static ObjectConverters.IsNotNull}}"/>
              <Button Content="View Changelog"
                      Command="{Binding OpenChangelogCommand}"
                      HorizontalAlignment="Stretch"/>
              <Button Content="View Version History"
                      Command="{Binding OpenVersionHistoryCommand}"
                      HorizontalAlignment="Stretch"/>
              <Separator/>
              <Button Content="Enable/Disable"
                      Command="{Binding ToggleModCommand}"
                      CommandParameter="{Binding SelectedMod}"
                      HorizontalAlignment="Stretch"/>
              <Button Content="Remove"
                      Command="{Binding RemoveModCommand}"
                      CommandParameter="{Binding SelectedMod}"
                      HorizontalAlignment="Stretch"/>
            </StackPanel>
          </StackPanel>
        </ScrollViewer>
      </Border>
    </Grid>

    <!-- Status Bar -->
    <Border Grid.Row="3" BorderBrush="#333" BorderThickness="0,1,0,0"
            Background="#2B2B2B" Padding="10">
      <TextBlock Text="{Binding StatusText}"/>
    </Border>
  </Grid>
</Window>
