# Full replacement workflow with self-hosted Windows runner enforced for Windows build.
# - Always runs Windows build on [self-hosted, windows]
# - Keeps Linux/macOS matrix builds separate
# - NuGet caching, separate restore & publish, MSBuild parallelism, binary logs uploaded
name: Tag, Build and Release

on:
  push:
    branches:
      - master

permissions:
  contents: write
  packages: write

jobs:
  set-version:
    name: Read version and set tag
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.read_version.outputs.tag }}
      version: ${{ steps.read_version.outputs.version }}
      full_version: ${{ steps.read_version.outputs.full_version }}
      prerelease: ${{ steps.read_version.outputs.prerelease }}
      icon_path: ${{ steps.read_version.outputs.icon_path }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed for commit count

      - name: Install xmllint
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils

      - name: Read version and icon from csproj
        id: read_version
        run: |
          version=$(xmllint --xpath "string(//Project/PropertyGroup/Version)" UI/FactorioModManager.csproj)
          if [ -z "$version" ]; then
            echo "No <Version> found in csproj" >&2
            exit 1
          fi

          # Read ApplicationIcon path
          icon_path=$(xmllint --xpath "string(//Project/PropertyGroup/ApplicationIcon)" UI/FactorioModManager.csproj)
          if [ -z "$icon_path" ]; then
            echo "Warning: No <ApplicationIcon> found in csproj" >&2
            icon_path=""
          fi

          # Get short commit SHA
          commit_sha=$(git rev-parse --short=7 HEAD)

          # Check if version contains prerelease identifier
          if echo "$version" | grep -qE '[-](alpha|beta|rc|dev|preview|pre|[A-Za-z])'; then
            # Append build metadata: run number + commit hash
            full_version="${version}.${GITHUB_RUN_NUMBER}+${commit_sha}"
            prerelease=true
          else
            # Release version - no suffix
            full_version="$version"
            prerelease=false
          fi

          # construct tag like v1.2.3 or v1.2.3-alpha
          tag="v${version}"

          echo "version=$version" >> $GITHUB_OUTPUT
          echo "full_version=$full_version" >> $GITHUB_OUTPUT
          echo "tag=$tag" >> $GITHUB_OUTPUT
          echo "prerelease=$prerelease" >> $GITHUB_OUTPUT
          echo "icon_path=$icon_path" >> $GITHUB_OUTPUT

          echo "Base version: $version"
          echo "Full version: $full_version"
          echo "Tag: $tag"
          echo "Prerelease: $prerelease"

  generate-icns:
    name: Generate macOS icon
    needs: set-version
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make generate-iconset script executable
        run: chmod +x scripts/generate-iconset.sh

      - name: Generate AppIcon.icns
        run: |
          if [ -f scripts/generate-iconset.sh ]; then
            ./scripts/generate-iconset.sh
          else
            echo "Error: scripts/generate-iconset.sh not found" >&2
            exit 1
          fi

      - name: Upload AppIcon.icns artifact
        uses: actions/upload-artifact@v4
        with:
          name: appicon
          path: ./AppIcon.icns

  # Build job for Linux and macOS (matrix excludes Windows)
  build:
    name: Build and package (Linux & macOS)
    needs: [set-version, generate-icns]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
            artifact_name: FactorioModManager-linux-x64
          - os: macos-latest
            platform: osx-x64
            artifact_name: FactorioModManager-osx-x64
          - os: macos-latest
            platform: osx-arm64
            artifact_name: FactorioModManager-osx-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Verify dotnet SDK
        run: |
          echo "dotnet binary: $(which dotnet)"
          dotnet --info
        shell: bash

      - name: Clear build artifacts (ensure fresh restore)
        run: |
          rm -rf UI/bin UI/obj
        shell: bash

      - name: Cache NuGet (Linux/macOS)
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
            ~/.local/share/NuGet
          key: nuget-${{ runner.os }}-${{ hashFiles('**/Directory.Packages.props','**/packages.lock.json', '**/*.csproj', '**/*.sln', 'global.json') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Restore dependencies
        run: dotnet restore UI/FactorioModManager.csproj
        shell: bash

      - name: Publish with parallel MSBuild and binary log
        run: dotnet publish UI/FactorioModManager.csproj --configuration Release --runtime ${{ matrix.platform }} --self-contained true -p:PublishSingleFile=false -p:UseAppHost=true -p:PublishTrimmed=false -bl:publish-${{ matrix.platform }}.binlog
        shell: bash

      - name: Upload msbuild binlog
        uses: actions/upload-artifact@v4
        with:
          name: msbuild-binlog-${{ matrix.platform }}
          path: publish-${{ matrix.platform }}.binlog
          if-no-files-found: ignore

      - name: Download AppIcon.icns
        if: startsWith(matrix.platform, 'osx-')
        uses: actions/download-artifact@v4
        with:
          name: appicon
          path: /tmp/appicon/

      - name: Create macOS .app bundle
        if: startsWith(matrix.platform, 'osx-')
        run: |
          APP_NAME="FactorioModManager"
          PLATFORM="${{ matrix.platform }}"
          VERSION="${{ needs.set-version.outputs.version }}"
          BUNDLE_VERSION=$(echo "$VERSION" | sed 's/-.*$//')
          PUBLISH_DIR="./publish/${PLATFORM}"
          APP_BUNDLE="${PUBLISH_DIR}/${APP_NAME}.app"

          mkdir -p "${APP_BUNDLE}/Contents/MacOS"
          mkdir -p "${APP_BUNDLE}/Contents/Resources"

          if [ -f "${PUBLISH_DIR}/${APP_NAME}" ]; then
            mv "${PUBLISH_DIR}/${APP_NAME}" "${APP_BUNDLE}/Contents/MacOS/" || true
            chmod +x "${APP_BUNDLE}/Contents/MacOS/${APP_NAME}" || true
          fi

          for f in "${PUBLISH_DIR}"/*.dll "${PUBLISH_DIR}"/*.deps.json "${PUBLISH_DIR}"/*.runtimeconfig.json "${PUBLISH_DIR}"/*.pdb; do
            if [ -f "$f" ]; then
              mv "$f" "${APP_BUNDLE}/Contents/MacOS/" || true
            fi
          done

          if [ -d "${PUBLISH_DIR}/runtimes" ]; then
            mv "${PUBLISH_DIR}/runtimes" "${APP_BUNDLE}/Contents/MacOS/" || true
          fi

          find "${PUBLISH_DIR}" -type f -name '*.dylib' -exec mv {} "${APP_BUNDLE}/Contents/MacOS/" \; || true

          if [ -f "/tmp/appicon/AppIcon.icns" ]; then
            cp /tmp/appicon/AppIcon.icns "${APP_BUNDLE}/Contents/Resources/AppIcon.icns"
            echo "AppIcon.icns copied to ${APP_BUNDLE}/Contents/Resources/"
          else
            echo "Warning: AppIcon.icns not found in /tmp/appicon/ - the application will use default icon" >&2
          fi

          cat > "${APP_BUNDLE}/Contents/Info.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleName</key>
            <string>${APP_NAME}</string>
            <key>CFBundleDisplayName</key>
            <string>Factorio Mod Manager</string>
            <key>CFBundleIdentifier</key>
            <string>com.yourname.factoriomodmanager</string>
            <key>CFBundleVersion</key>
            <string>${BUNDLE_VERSION}</string>
            <key>CFBundleShortVersionString</key>
            <string>${VERSION}</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleExecutable</key>
            <string>${APP_NAME}</string>
            <key>CFBundleIconFile</key>
            <string>AppIcon</string>
            <key>LSMinimumSystemVersion</key>
            <string>10.15</string>
            <key>NSHighResolutionCapable</key>
            <true/>
          </dict>
          </plist>
          EOF

          find "${PUBLISH_DIR}" -maxdepth 1 -type f -not -name "${APP_NAME}.app" -delete || true
          find "${PUBLISH_DIR}" -maxdepth 1 -type d ! -name "${APP_NAME}.app" ! -path "${PUBLISH_DIR}" -exec rm -rf {} + || true
        shell: bash

      - name: Create archive (Linux/macOS)
        run: |
          cd publish/${{ matrix.platform }}
          tar -czf ../../${{ matrix.artifact_name }}.tar.gz ./*
        shell: bash

      - name: Upload artifact (Linux/macOS)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            ${{ matrix.artifact_name }}.tar.gz
          if-no-files-found: ignore

  # Windows build job: always use self-hosted Windows runner
  build-windows:
    name: Build and package (Windows)
    needs: [set-version, generate-icns]
    runs-on:
      - self-hosted
      - windows
    strategy:
      matrix:
        include:
          - platform: win-x64
            artifact_name: FactorioModManager-win-x64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Verify dotnet SDK
        run: |
          echo "dotnet binary:
          $(Get-Command dotnet | Select-Object -ExpandProperty Source)"
          dotnet --info
        shell: pwsh

      - name: Clear build artifacts (ensure fresh restore)
        run: |
          rm -rf UI/bin UI/obj
        shell: pwsh

      - name: Cache NuGet on Windows
        uses: actions/cache@v4
        with:
          path: |
            %USERPROFILE%\.nuget\packages
            %USERPROFILE%\.nuget\plugins
          key: nuget-windows-${{ hashFiles('**/Directory.Packages.props','**/packages.lock.json', '**/*.csproj', '**/*.sln', 'global.json') }}
          restore-keys: |
            nuget-windows-

      - name: Restore dependencies (Windows)
        run: dotnet restore UI/FactorioModManager.csproj
        shell: pwsh

      - name: Publish (Windows) with parallel MSBuild and binary log
        run: dotnet publish UI/FactorioModManager.csproj --configuration Release --runtime ${{ matrix.platform }} --self-contained true -p:PublishSingleFile=false -p:UseAppHost=true -p:PublishTrimmed=false -bl:publish-${{ matrix.platform }}.binlog
        shell: pwsh

      - name: Upload msbuild binlog (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: msbuild-binlog-${{ matrix.platform }}
          path: publish-${{ matrix.platform }}.binlog
          if-no-files-found: ignore

      - name: Create archive (Windows)
        shell: pwsh
        run: |
          cd publish/${{ matrix.platform }}
          Compress-Archive -Path * -DestinationPath ../../${{ matrix.artifact_name }}.zip

      - name: Upload artifact (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            ${{ matrix.artifact_name }}.zip
          if-no-files-found: ignore

  release:
    name: Create GitHub Release
    needs: [set-version, build, build-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Determine release metadata
        id: release_type
        run: |
          TAG="${{ needs.set-version.outputs.tag }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "prerelease=${{ needs.set-version.outputs.prerelease }}" >> $GITHUB_OUTPUT

      - name: Create Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.release_type.outputs.tag }}
          tag_name: ${{ steps.release_type.outputs.tag }}
          prerelease: ${{ steps.release_type.outputs.prerelease }}
          draft: false
          generate_release_notes: true
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
